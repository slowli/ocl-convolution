dist: xenial
addons:
  apt:
    sources:
      - key_url: https://apt.llvm.org/llvm-snapshot.gpg.key
        sourceline: 'deb [arch=amd64] http://apt.llvm.org/xenial/ llvm-toolchain-xenial-8 main'
    packages:
      # General stuff
      - build-essential
      - cmake
      - pkg-config
      - libhwloc-dev
      - zlib1g-dev
      # OpenCL-related utils
      - ocl-icd-libopencl1
      - ocl-icd-dev
      - ocl-icd-opencl-dev
      - clinfo
      # LLVM-related stuff
      - clang-8
      - libclang-8-dev
      - llvm-8
      - llvm-8-dev

language: rust

branches:
  only:
    - master
    # Github release tags (for example "v0.9" or "v0.9.1").
    - /^v\d+\.\d+(\.\d+)?(-\S*)?$/
    # Branch names endings with "-release" (for example "0.9.0-release").
    - /-release$/

rust:
  - 1.34.0

env:
  global:
    - DEADLINKS_VERS=0.3.0
    - POCL_VER=1.3

cache:
  cargo: true
  directories:
    - $HOME/.local

before_install:
  # Build `pocl` distribution if necessary.
  - |
    if [[ ! -x "~/.local/pocl-$POCL_VER/build/bin/poclcc" ]]; then
      mkdir -p ~/.local && cd ~/.local
      curl -sSL "https://github.com/pocl/pocl/archive/v$POCL_VER.tar.gz" > pocl-$POCL_VER.tar.gz
      tar xf "pocl-$POCL_VER.tar.gz"
      cd pocl-$POCL_VER
      mkdir -p build && cd build
      cmake -DWITH_LLVM_CONFIG=/usr/bin/llvm-config-8 -DCMAKE_INSTALL_PREFIX=/usr ..
      make
      cd $TRAVIS_BUILD_DIR
    fi
  - (cd ~/.local/pocl-$POCL_VER/build && sudo make install)
  - clinfo
install:
  - rustup component add rustfmt
  - rustfmt -V
  - rustup component add clippy
  - cargo clippy --version
  - cargo deadlinks -V | grep $DEADLINKS_VERS || cargo install cargo-deadlinks --vers $DEADLINKS_VERS --force

script:
  - cargo fmt --all -- --check
  - cargo clippy --all --tests --examples --benches -- -D warnings
  - cargo test
  - cargo clean --doc && cargo doc --no-deps && cargo deadlinks --dir target/doc

deploy:
  provider: pages
  local-dir: target/doc
  skip-cleanup: true
  github-token: $GITHUB_TOKEN
  on:
    branch: master
